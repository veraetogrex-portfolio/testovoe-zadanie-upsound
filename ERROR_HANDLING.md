# ะกะธััะตะผะฐ ะพะฑัะฐะฑะพัะบะธ ะพัะธะฑะพะบ

ะะพั ัะตะฐะปะธะทัะตั 4-ััะฐะฟะฝัั ะฒะฐะปะธะดะฐัะธั ั ะดะตัะฐะปัะฝะพะน ะพะฑัะฐะฑะพัะบะพะน ะพัะธะฑะพะบ ัะพะณะปะฐัะฝะพ ัะตัะฝะธัะตัะบะพะผั ะทะฐะดะฐะฝะธั.

## ะััะธัะตะบัััะฐ ะฒะฐะปะธะดะฐัะธะธ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         PIPELINE ะะะะะะะฆะะ                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  ะัะพะดััะตะต        โโโโโโโโโโโโ   โโโโโโโโโโโโ   โโโโโโโโโโโโ   โโโโโโโโโโโโ โ
โ  ัะพะพะฑัะตะฝะธะต โโโโโโถโ  ะญัะฐะฟ 1  โโโโถโ  ะญัะฐะฟ 2  โโโโถโ  ะญัะฐะฟ 3  โโโโถโ  ะญัะฐะฟ 4  โ โ
โ                  โ  ะขะธะฟ     โ   โ  ะคะพัะผะฐั  โ   โ  HTTP    โ   โ  ะะฐะฝะฝัะต  โ โ
โ                  โ  ะดะฐะฝะฝัั  โ   โ  URL     โ   โ  ะทะฐะฟัะพั  โ   โ  JSON-LD โ โ
โ                  โโโโโโฌโโโโโโ   โโโโโโฌโโโโโโ   โโโโโโฌโโโโโโ   โโโโโโฌโโโโโโ โ
โ                       โ              โ              โ              โ       โ
โ                       โผ              โผ              โผ              โผ       โ
โ                  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                  โ              ะะะะะะะขะงะะ ะะจะะะะ                       โ  โ
โ                  โ         (ัะพัะผะธัะพะฒะฐะฝะธะต ะพัะฒะตัะฐ ะฟะพะปัะทะพะฒะฐัะตะปั)          โ  โ
โ                  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ะญัะฐะฟ 1: ะะฐะปะธะดะฐัะธั ัะธะฟะฐ ะดะฐะฝะฝัั

**ะะพะดัะปั:** `handlers/common.py`

ะัะพะฒะตัะบะธ:
- ะกะพะพะฑัะตะฝะธะต ะฝะต ะฟัััะพะต
- ะกะพะดะตัะถะธั ัััะปะบั ะฝะฐ ะฏะฝะดะตะบั.ะัะทัะบั

## ะญัะฐะฟ 2: ะะฐะปะธะดะฐัะธั ัะพัะผะฐัะฐ URL

**ะะพะดัะปั:** `utils/validators.py`

### ะะพะดะดะตัะถะธะฒะฐะตะผัะต ะดะพะผะตะฝั:
- music.yandex.ru
- music.yandex.com
- music.yandex.by
- music.yandex.kz
- music.yandex.ua

### ะะตัะฐะปัะฝะฐั ะฒะฐะปะธะดะฐัะธั:

| ะัะพะฒะตัะบะฐ | ะัะบะปััะตะฝะธะต | ะกะพะพะฑัะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั |
|----------|------------|------------------------|
| ะะต URL | `NotUrlError` | "โ ะญัะพ ะฝะต ะฟะพัะพะถะต ะฝะฐ ัััะปะบั..." |
| ะงัะถะพะน ะดะพะผะตะฝ | `WrongDomainError` | "โ ะฏ ัะฐะฑะพัะฐั ัะพะปัะบะพ ั ะฏะฝะดะตะบั.ะัะทัะบะพะน..." |
| ะะต ะัะทัะบะฐ | `WrongServiceError` | "โ ะญัะพ ะฝะต ะฏะฝะดะตะบั.ะัะทัะบะฐ..." |
| ะกััะปะบะฐ ะฝะฐ ะฐะปัะฑะพะผ | `AlbumUrlError` | "โ ะญัะพ ัััะปะบะฐ ะฝะฐ ะฐะปัะฑะพะผ, ะฐ ะฝะต ะฝะฐ ััะตะบ..." |
| ะกััะปะบะฐ ะฝะฐ ะฐััะธััะฐ | `ArtistUrlError` | "โ ะญัะพ ัััะปะบะฐ ะฝะฐ ะฐััะธััะฐ..." |
| ะกััะปะบะฐ ะฝะฐ ะฟะปะตะนะปะธัั | `PlaylistUrlError` | "โ ะญัะพ ัััะปะบะฐ ะฝะฐ ะฟะปะตะนะปะธัั..." |
| ะะตะฒะฐะปะธะดะฝัะต ID | `InvalidTrackIdError` | "โ ะะตะฒะตัะฝัะน ัะพัะผะฐั ัััะปะบะธ..." |

## ะญัะฐะฟ 3: HTTP-ะทะฐะฟัะพั ั Retry-ะฟะพะปะธัะธะบะพะน

**ะะพะดัะปั:** `services/yandex_parser.py`

### Retry-ะบะพะฝัะธะณััะฐัะธั:
- ะะฐะบัะธะผัะผ ะฟะพะฟััะพะบ: **2 retry** (3 ะฟะพะฟััะบะธ ะฒัะตะณะพ)
- ะะฐะดะตัะถะบะฐ ะผะตะถะดั ะฟะพะฟััะบะฐะผะธ: **1 ัะตะบัะฝะดะฐ**
- Retry ะดะปั ะบะพะดะพะฒ: **502, 503, 504**
- Retry ะดะปั ะพัะธะฑะพะบ: **Timeout, RemoteProtocolError**

### HTTP-ะพัะธะฑะบะธ:

| ะะพะด | ะัะบะปััะตะฝะธะต | ะกะพะพะฑัะตะฝะธะต | Retry |
|-----|------------|-----------|-------|
| 400 | `BadRequestError` | "โ๏ธ ะะตะบะพััะตะบัะฝัะน ะทะฐะฟัะพั..." | โ |
| 403 | `ForbiddenError` | "๐ ะะพัััะฟ ะพะณัะฐะฝะธัะตะฝ (ะณะตะพะฑะปะพะบะธัะพะฒะบะฐ)" | โ |
| 404 | `TrackNotFoundError` | "โ ะขัะตะบ ะฝะต ะฝะฐะนะดะตะฝ..." | โ |
| 410 | `TrackDeletedError` | "โ ะขัะตะบ ะฑัะป ัะดะฐะปัะฝ..." | โ |
| 429 | `RateLimitError` | "โณ ะกะปะธัะบะพะผ ะผะฝะพะณะพ ะทะฐะฟัะพัะพะฒ..." | โ |
| 500 | `ServerError` | "โ๏ธ ะัะธะฑะบะฐ ะฝะฐ ัะตัะฒะตัะต..." | โ |
| 502 | `BadGatewayError` | "โ๏ธ ะฏะฝะดะตะบั.ะัะทัะบะฐ ะฝะตะดะพัััะฟะฝะฐ..." | โ |
| 503 | `ServiceUnavailableError` | "โ๏ธ ะกะตัะฒะธั ะฝะฐ ะพะฑัะปัะถะธะฒะฐะฝะธะธ..." | โ |
| 504 | `GatewayTimeoutError` | "โ๏ธ ะกะตัะฒะตั ะฝะต ะพัะฒะตัะฐะตั..." | โ |

### ะกะตัะตะฒัะต ะพัะธะฑะบะธ:

| ะัะธะฑะบะฐ | ะัะบะปััะตะฝะธะต | ะกะพะพะฑัะตะฝะธะต | Retry |
|--------|------------|-----------|-------|
| Connect timeout | `ConnectTimeoutError` | "โฑ๏ธ ะะต ัะดะฐะปะพัั ะฟะพะดะบะปััะธัััั..." | โ |
| Read timeout | `ReadTimeoutError` | "โฑ๏ธ ะฏะฝะดะตะบั.ะัะทัะบะฐ ะพัะฒะตัะฐะตั ัะปะธัะบะพะผ ะดะพะปะณะพ..." | โ |
| Connection error | `ConnectionError` | "โ๏ธ ะะต ัะดะฐะปะพัั ะฝะฐะนัะธ ัะตัะฒะตั..." | โ |
| SSL error | `SSLError` | "๐ ะัะธะฑะบะฐ ะฑะตะทะพะฟะฐัะฝะพะณะพ ัะพะตะดะธะฝะตะฝะธั..." | โ |
| Protocol error | `RemoteProtocolError` | "โ๏ธ ะกะพะตะดะธะฝะตะฝะธะต ะฟัะตัะฒะฐะฝะพ..." | โ |

## ะญัะฐะฟ 4: ะะฐััะธะฝะณ ะธ ะฒะฐะปะธะดะฐัะธั ะดะฐะฝะฝัั

**ะะพะดัะปั:** `services/yandex_parser.py`

### ะะฐะปะธะดะฐัะธั JSON-LD:

| ะัะพะฒะตัะบะฐ | ะัะบะปััะตะฝะธะต | ะกะพะพะฑัะตะฝะธะต |
|----------|------------|-----------|
| JSON-LD ะพััััััะฒัะตั | `JsonLdNotFoundError` | "โ๏ธ ะะต ัะดะฐะปะพัั ะฝะฐะนัะธ ะดะฐะฝะฝัะต ะพ ััะตะบะต..." |
| JSON ะฝะตะฒะฐะปะธะดะฝัะน | `JsonParseError` | "โ๏ธ ะัะธะฑะบะฐ ััะตะฝะธั ะดะฐะฝะฝัั..." |
| ะะตะฒะตัะฝัะน ัะธะฟ ััะตะผั | `WrongSchemaTypeError` | "โ๏ธ ะกััะฐะฝะธัะฐ ะฝะต ัะพะดะตัะถะธั ะธะฝัะพัะผะฐัะธะธ ะพ ััะตะบะต" |
| ะััััััะฒัะตั ะฟะพะปะต | `MissingFieldError` | "โ๏ธ ะะต ัะดะฐะปะพัั ะฟะพะปััะธัั ะฟะพะปะฝัะต ะดะฐะฝะฝัะต..." |
| ะัััะพะต ะฟะพะปะต | `EmptyFieldError` | "โ๏ธ ะะพะปััะตะฝั ะฟััััะต ะดะฐะฝะฝัะต..." |

### ะะฑัะฐะฑะพัะบะฐ ะพััััััะฒัััะธั ะดะฐะฝะฝัั:

| ะะพะปะต | Fallback | ะะพะฒะตะดะตะฝะธะต |
|------|----------|-----------|
| `name` | โ | โ ะัะบะปััะตะฝะธะต `MissingFieldError` |
| `byArtist` | "ะะตะธะทะฒะตััะฝัะน ะฐััะธัั" | โ ะัะฟะพะปัะทัะตััั fallback |
| `duration` | "โ" | โ ะัะฟะพะปัะทัะตััั fallback |
| `inAlbum` | `null` | โ ะะพะปะต ะพะฟัะธะพะฝะฐะปัะฝะพะต |

## ะะตัะฐััะธั ะธัะบะปััะตะฝะธะน

```
YandexMusicBotError (ะฑะฐะทะพะฒัะน ะบะปะฐัั)
โ
โโโ ValidationError (ะพัะธะฑะบะธ ะฒะฐะปะธะดะฐัะธะธ)
โ   โโโ EmptyMessageError
โ   โโโ MessageTooLongError
โ   โโโ NotUrlError
โ   โโโ WrongDomainError
โ   โโโ WrongServiceError
โ   โโโ NotTrackUrlError
โ   โ   โโโ AlbumUrlError
โ   โ   โโโ ArtistUrlError
โ   โ   โโโ PlaylistUrlError
โ   โโโ InvalidTrackIdError
โ
โโโ HttpError (HTTP-ะพัะธะฑะบะธ)
โ   โโโ TrackNotFoundError (404)
โ   โโโ TrackDeletedError (410)
โ   โโโ ForbiddenError (403)
โ   โโโ RateLimitError (429)
โ   โโโ BadRequestError (400)
โ   โโโ ServerError (500)
โ   โโโ BadGatewayError (502)
โ   โโโ ServiceUnavailableError (503)
โ   โโโ GatewayTimeoutError (504)
โ
โโโ NetworkError (ัะตัะตะฒัะต ะพัะธะฑะบะธ)
โ   โโโ ConnectTimeoutError
โ   โโโ ReadTimeoutError
โ   โโโ ConnectionError
โ   โโโ SSLError
โ   โโโ RemoteProtocolError
โ
โโโ ParsingError (ะพัะธะฑะบะธ ะฟะฐััะธะฝะณะฐ)
    โโโ JsonLdNotFoundError
    โโโ JsonParseError
    โโโ WrongSchemaTypeError
    โโโ MissingFieldError
    โโโ InvalidFieldTypeError
    โโโ EmptyFieldError
    โโโ InvalidDurationFormatError
```

## ะะพะณะธัะพะฒะฐะฝะธะต

### ะฃัะพะฒะฝะธ ะปะพะณะธัะพะฒะฐะฝะธั ะฟะพ ัะธะฟั ะพัะธะฑะบะธ:

| ะขะธะฟ ะพัะธะฑะบะธ | ะฃัะพะฒะตะฝั | ะัะธะผะตัะฐะฝะธะต |
|------------|---------|------------|
| `ValidationError` | DEBUG | ะะถะธะดะฐะตะผัะต ะพัะธะฑะบะธ ะฟะพะปัะทะพะฒะฐัะตะปั |
| `TrackNotFoundError` | INFO | ะะฝัะพัะผะฐัะธะพะฝะฝัะต |
| `RateLimitError` | WARNING | ะขัะตะฑััั ะฒะฝะธะผะฐะฝะธั |
| `NetworkError` | WARNING | ะัะตะผะตะฝะฝัะต ะฟัะพะฑะปะตะผั |
| `ParsingError` | ERROR | ะะพะทะผะพะถะฝะพ, ัะปะพะผะฐะปัั ะฟะฐััะธะฝะณ |
| `ServerError` | ERROR | ะัะพะฑะปะตะผั ัะตัะฒะธัะฐ |
| ะะตะฟัะตะดะฒะธะดะตะฝะฝัะต | CRITICAL | ะขัะตะฑััั ะฝะตะผะตะดะปะตะฝะฝะพะณะพ ะธัะฟัะฐะฒะปะตะฝะธั |

### ะคะพัะผะฐั ะปะพะณะฐ:

```
2026-01-29 12:34:56 - src.handlers.common - INFO - ะะพะปัะทะพะฒะฐัะตะปั 12345 ะพัะฟัะฐะฒะธะป URL: https://...
2026-01-29 12:34:57 - src.services.yandex_parser - INFO - ะะพะปััะตะฝะธะต ััะตะบะฐ: https://...
2026-01-29 12:34:58 - src.handlers.common - INFO - ะฃัะฟะตัะฝะพ ะพัะฟัะฐะฒะปะตะฝะฐ ะธะฝัะพัะผะฐัะธั ะพ ััะตะบะต ะฟะพะปัะทะพะฒะฐัะตะปั 12345
```

## ะัะธะผะตัั ัะฐะฑะพัั

### ะฃัะฟะตัะฝัะน ะทะฐะฟัะพั:
```
ะะพะปัะทะพะฒะฐัะตะปั: https://music.yandex.ru/album/3192570/track/26464125

ะะพั: ๐ต ะะฐะทะฒะฐะฝะธะต: ะััะฟะฟะฐ ะบัะพะฒะธ
     ๐ค ะััะธัั: ะะธะฝะพ
     โฑ๏ธ ะะปะธัะตะปัะฝะพััั: 4:47
     ๐ฟ ะะปัะฑะพะผ: ะััะฟะฟะฐ ะบัะพะฒะธ
```

### ะัะธะฑะบะฐ ะฒะฐะปะธะดะฐัะธะธ (ะฐะปัะฑะพะผ ะฒะผะตััะพ ััะตะบะฐ):
```
ะะพะปัะทะพะฒะฐัะตะปั: https://music.yandex.ru/album/3192570

ะะพั: โ ะญัะพ ัััะปะบะฐ ะฝะฐ ะฐะปัะฑะพะผ, ะฐ ะฝะต ะฝะฐ ััะตะบ.
     ะัะบัะพะนัะต ะบะพะฝะบัะตัะฝัะน ััะตะบ ะธ ัะบะพะฟะธััะนัะต ัััะปะบั ะฝะฐ ะฝะตะณะพ
```

### ะขัะตะบ ะฝะต ะฝะฐะนะดะตะฝ (404):
```
ะะพะปัะทะพะฒะฐัะตะปั: https://music.yandex.ru/album/999999/track/999999

ะะพั: โ ะขัะตะบ ะฝะต ะฝะฐะนะดะตะฝ. ะะพะทะผะพะถะฝะพ, ะพะฝ ะฑัะป ัะดะฐะปัะฝ ะธะปะธ ัััะปะบะฐ ะฝะตะฒะตัะฝะฐ.
```

### ะกะตัะตะฒะฐั ะพัะธะฑะบะฐ ั retry:
```
ะะพะณ: ะะพะฒัะพัะฝะฐั ะฟะพะฟััะบะฐ 1/2 ะดะปั https://...
ะะพะณ: ะะพะฒัะพัะฝะฐั ะฟะพะฟััะบะฐ 2/2 ะดะปั https://...

ะะพั: โฑ๏ธ ะฏะฝะดะตะบั.ะัะทัะบะฐ ะพัะฒะตัะฐะตั ัะปะธัะบะพะผ ะดะพะปะณะพ. ะะพะฟัะพะฑัะนัะต ะตัั ัะฐะท
```

## ะะพะฝัะธะณััะฐัะธั

ะ ัะฐะนะปะต `config.py`:

```python
# Retry-ะฟะพะปะธัะธะบะฐ
MAX_RETRIES = 2  # ะะฐะบัะธะผะฐะปัะฝะพะต ะบะพะปะธัะตััะฒะพ ะฟะพะฒัะพัะฝัั ะฟะพะฟััะพะบ
RETRY_DELAY = 1.0  # ะะฐะดะตัะถะบะฐ ะผะตะถะดั ะฟะพะฟััะบะฐะผะธ (ัะตะบัะฝะดั)
RETRY_STATUS_CODES = (502, 503, 504)  # HTTP-ะบะพะดั ะดะปั retry

# HTTP-ะบะปะธะตะฝั
REQUEST_TIMEOUT = 10  # ะขะฐะนะผะฐัั ะทะฐะฟัะพัะฐ (ัะตะบัะฝะดั)
USER_AGENT = "Mozilla/5.0 ..."  # User-Agent ะดะปั ะทะฐะฟัะพัะพะฒ
```

## ะะตะทะพะฟะฐัะฝะพััั

1. **HTML-ัะบัะฐะฝะธัะพะฒะฐะฝะธะต:** ะัะต ะฝะฐะทะฒะฐะฝะธั ััะตะบะพะฒ ะธ ะฐััะธััะพะฒ ัะบัะฐะฝะธัััััั ะฟะตัะตะด ะพัะฟัะฐะฒะบะพะน
2. **ะะฐะปะธะดะฐัะธั URL:** ะะฐัะธัะฐ ะพั SSRF ัะตัะตะท ัััะพะณัั ะฒะฐะปะธะดะฐัะธั ะดะพะผะตะฝะพะฒ
3. **ะขะฐะนะผะฐััั:** ะะณัะฐะฝะธัะตะฝะธะต ะฒัะตะผะตะฝะธ ะฒัะฟะพะปะฝะตะฝะธั ะทะฐะฟัะพัะพะฒ
4. **Graceful degradation:** Fallback-ะทะฝะฐัะตะฝะธั ะดะปั ะฝะตะพะฑัะทะฐัะตะปัะฝัั ะฟะพะปะตะน

## ะขะตััะธัะพะฒะฐะฝะธะต

ะะปั ัะตััะธัะพะฒะฐะฝะธั ะธัะฟะพะปัะทัะนัะต ะฟัะธะผะตัั ะธะท `README.md` ัะฐะทะดะตะปะฐ "ะขะตััะธัะพะฒะฐะฝะธะต".

### ะััััะฐั ะฟัะพะฒะตัะบะฐ ะฒัะตั ัะธะฟะพะฒ ะพัะธะฑะพะบ:

```bash
# ะะฐะปะธะดะฝะฐั ัััะปะบะฐ
https://music.yandex.ru/album/3192570/track/26464125

# ะกััะปะบะฐ ะฝะฐ ะฐะปัะฑะพะผ
https://music.yandex.ru/album/3192570

# ะกััะปะบะฐ ะฝะฐ ะฐััะธััะฐ
https://music.yandex.ru/artist/12345

# ะะตัััะตััะฒัััะธะน ััะตะบ
https://music.yandex.ru/album/999999/track/999999

# ะงัะถะพะน ะดะพะผะตะฝ
https://spotify.com/track/abc123

# ะะต URL
ะฟัะธะฒะตั
```
